name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest

      - name: Install llama.cpp
        run: |
          brew install llama.cpp

      - name: Create App Icon
        run: |
          mkdir -p AppIcon.iconset

          # Apply rounded corners (macOS style ~22% radius)
          swift -e '
          import AppKit
          let src = NSImage(contentsOfFile: "Resources/AirLingua.png")!
          let canvas = NSSize(width: 1024, height: 1024)
          let scale: CGFloat = 0.80
          let iconSize = NSSize(width: canvas.width * scale, height: canvas.height * scale)
          let offset = (canvas.width - iconSize.width) / 2
          let radius = iconSize.width * 0.22
          let img = NSImage(size: canvas)
          img.lockFocus()
          NSColor.clear.setFill()
          NSRect(origin: .zero, size: canvas).fill()
          let rect = NSRect(x: offset, y: offset, width: iconSize.width, height: iconSize.height)
          NSBezierPath(roundedRect: rect, xRadius: radius, yRadius: radius).addClip()
          src.draw(in: rect)
          img.unlockFocus()
          let data = img.tiffRepresentation.flatMap { NSBitmapImageRep(data: $0) }?.representation(using: .png, properties: [:])
          try! data!.write(to: URL(fileURLWithPath: "/tmp/icon_processed.png"))
          '

          SRC="/tmp/icon_processed.png"
          sips -z 16 16     "$SRC" --out AppIcon.iconset/icon_16x16.png
          sips -z 32 32     "$SRC" --out AppIcon.iconset/icon_16x16@2x.png
          sips -z 32 32     "$SRC" --out AppIcon.iconset/icon_32x32.png
          sips -z 64 64     "$SRC" --out AppIcon.iconset/icon_32x32@2x.png
          sips -z 128 128   "$SRC" --out AppIcon.iconset/icon_128x128.png
          sips -z 256 256   "$SRC" --out AppIcon.iconset/icon_128x128@2x.png
          sips -z 256 256   "$SRC" --out AppIcon.iconset/icon_256x256.png
          sips -z 512 512   "$SRC" --out AppIcon.iconset/icon_256x256@2x.png
          sips -z 512 512   "$SRC" --out AppIcon.iconset/icon_512x512.png
          sips -z 1024 1024 "$SRC" --out AppIcon.iconset/icon_512x512@2x.png

          # Copy to Asset Catalog
          ICON_DIR="LocalTranslate/Assets.xcassets/AppIcon.appiconset"
          mkdir -p "$ICON_DIR"
          cp AppIcon.iconset/* "$ICON_DIR/"

          # Create Contents.json
          cat > "$ICON_DIR/Contents.json" << 'ICONJSON'
          {
            "images" : [
              { "filename" : "icon_16x16.png", "idiom" : "mac", "scale" : "1x", "size" : "16x16" },
              { "filename" : "icon_16x16@2x.png", "idiom" : "mac", "scale" : "2x", "size" : "16x16" },
              { "filename" : "icon_32x32.png", "idiom" : "mac", "scale" : "1x", "size" : "32x32" },
              { "filename" : "icon_32x32@2x.png", "idiom" : "mac", "scale" : "2x", "size" : "32x32" },
              { "filename" : "icon_128x128.png", "idiom" : "mac", "scale" : "1x", "size" : "128x128" },
              { "filename" : "icon_128x128@2x.png", "idiom" : "mac", "scale" : "2x", "size" : "128x128" },
              { "filename" : "icon_256x256.png", "idiom" : "mac", "scale" : "1x", "size" : "256x256" },
              { "filename" : "icon_256x256@2x.png", "idiom" : "mac", "scale" : "2x", "size" : "256x256" },
              { "filename" : "icon_512x512.png", "idiom" : "mac", "scale" : "1x", "size" : "512x512" },
              { "filename" : "icon_512x512@2x.png", "idiom" : "mac", "scale" : "2x", "size" : "512x512" }
            ],
            "info" : { "author" : "xcode", "version" : 1 }
          }
          ICONJSON

          rm -rf AppIcon.iconset

      - name: Build
        run: |
          xcodebuild -project LocalTranslate.xcodeproj \
            -scheme LocalTranslate \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO

      - name: Prepare App Bundle
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          APP_PATH="build/Build/Products/Release/LocalTranslate.app"

          # Rename to AirLingua.app
          mv "$APP_PATH" "build/Build/Products/Release/AirLingua.app"
          APP_PATH="build/Build/Products/Release/AirLingua.app"

          # Bundle llama-completion with dependencies
          RESOURCES_DIR="$APP_PATH/Contents/Resources"
          LLAMA_BIN="/opt/homebrew/bin/llama-completion"
          LLAMA_LIB="/opt/homebrew/lib/libllama.dylib"

          # Copy binary
          cp "$LLAMA_BIN" "$RESOURCES_DIR/"
          chmod +x "$RESOURCES_DIR/llama-completion"

          # Copy library
          cp "$LLAMA_LIB" "$RESOURCES_DIR/"

          # Fix rpath to look in same directory
          install_name_tool -change "@rpath/libllama.0.dylib" "@executable_path/libllama.dylib" "$RESOURCES_DIR/llama-completion"

          # Remove quarantine attribute
          xattr -cr "$APP_PATH"

      - name: Create ZIP
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          cd build/Build/Products/Release
          zip -r "AirLingua-${VERSION}.zip" "AirLingua.app"
          mv "AirLingua-${VERSION}.zip" "$GITHUB_WORKSPACE/"
          cd "$GITHUB_WORKSPACE"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          SHA256=$(shasum -a 256 "AirLingua-${VERSION}.zip" | cut -d ' ' -f 1)
          echo "SHA256=${SHA256}" >> $GITHUB_ENV

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: AirLingua-${{ env.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew Tap
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          repository: fuwasegu/homebrew-tap
          event-type: update-airlingua
          client-payload: '{"version": "${{ env.VERSION }}", "sha256": "${{ env.SHA256 }}"}'
