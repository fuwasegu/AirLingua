name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest

      - name: Install llama.cpp
        run: |
          brew install llama.cpp

      - name: Create App Icon
        run: |
          mkdir -p AppIcon.iconset

          # Apply rounded corners (macOS style ~22% radius)
          swift -e '
          import AppKit
          let src = NSImage(contentsOfFile: "Resources/AirLingua.png")!
          let canvas = NSSize(width: 1024, height: 1024)
          let scale: CGFloat = 0.80
          let iconSize = NSSize(width: canvas.width * scale, height: canvas.height * scale)
          let offset = (canvas.width - iconSize.width) / 2
          let radius = iconSize.width * 0.22
          let img = NSImage(size: canvas)
          img.lockFocus()
          NSColor.clear.setFill()
          NSRect(origin: .zero, size: canvas).fill()
          let rect = NSRect(x: offset, y: offset, width: iconSize.width, height: iconSize.height)
          NSBezierPath(roundedRect: rect, xRadius: radius, yRadius: radius).addClip()
          src.draw(in: rect)
          img.unlockFocus()
          let data = img.tiffRepresentation.flatMap { NSBitmapImageRep(data: $0) }?.representation(using: .png, properties: [:])
          try! data!.write(to: URL(fileURLWithPath: "/tmp/icon_processed.png"))
          '

          SRC="/tmp/icon_processed.png"
          sips -z 16 16     "$SRC" --out AppIcon.iconset/icon_16x16.png
          sips -z 32 32     "$SRC" --out AppIcon.iconset/icon_16x16@2x.png
          sips -z 32 32     "$SRC" --out AppIcon.iconset/icon_32x32.png
          sips -z 64 64     "$SRC" --out AppIcon.iconset/icon_32x32@2x.png
          sips -z 128 128   "$SRC" --out AppIcon.iconset/icon_128x128.png
          sips -z 256 256   "$SRC" --out AppIcon.iconset/icon_128x128@2x.png
          sips -z 256 256   "$SRC" --out AppIcon.iconset/icon_256x256.png
          sips -z 512 512   "$SRC" --out AppIcon.iconset/icon_256x256@2x.png
          sips -z 512 512   "$SRC" --out AppIcon.iconset/icon_512x512.png
          sips -z 1024 1024 "$SRC" --out AppIcon.iconset/icon_512x512@2x.png

          # Copy to Asset Catalog
          ICON_DIR="LocalTranslate/Assets.xcassets/AppIcon.appiconset"
          mkdir -p "$ICON_DIR"
          cp AppIcon.iconset/* "$ICON_DIR/"

          # Create Contents.json
          cat > "$ICON_DIR/Contents.json" << 'ICONJSON'
          {
            "images" : [
              { "filename" : "icon_16x16.png", "idiom" : "mac", "scale" : "1x", "size" : "16x16" },
              { "filename" : "icon_16x16@2x.png", "idiom" : "mac", "scale" : "2x", "size" : "16x16" },
              { "filename" : "icon_32x32.png", "idiom" : "mac", "scale" : "1x", "size" : "32x32" },
              { "filename" : "icon_32x32@2x.png", "idiom" : "mac", "scale" : "2x", "size" : "32x32" },
              { "filename" : "icon_128x128.png", "idiom" : "mac", "scale" : "1x", "size" : "128x128" },
              { "filename" : "icon_128x128@2x.png", "idiom" : "mac", "scale" : "2x", "size" : "128x128" },
              { "filename" : "icon_256x256.png", "idiom" : "mac", "scale" : "1x", "size" : "256x256" },
              { "filename" : "icon_256x256@2x.png", "idiom" : "mac", "scale" : "2x", "size" : "256x256" },
              { "filename" : "icon_512x512.png", "idiom" : "mac", "scale" : "1x", "size" : "512x512" },
              { "filename" : "icon_512x512@2x.png", "idiom" : "mac", "scale" : "2x", "size" : "512x512" }
            ],
            "info" : { "author" : "xcode", "version" : 1 }
          }
          ICONJSON

          rm -rf AppIcon.iconset

      - name: Build
        run: |
          xcodebuild -project LocalTranslate.xcodeproj \
            -scheme LocalTranslate \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO

      - name: Prepare App Bundle
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          APP_PATH="build/Build/Products/Release/LocalTranslate.app"

          # Rename to AirLingua.app
          mv "$APP_PATH" "build/Build/Products/Release/AirLingua.app"
          APP_PATH="build/Build/Products/Release/AirLingua.app"

          # Bundle llama-completion with all dependencies
          RESOURCES_DIR="$APP_PATH/Contents/Resources"
          LLAMA_BIN="/opt/homebrew/bin/llama-completion"

          # Copy binary
          cp "$LLAMA_BIN" "$RESOURCES_DIR/"
          chmod +x "$RESOURCES_DIR/llama-completion"

          echo "=== Original llama-completion dependencies ==="
          otool -L "$LLAMA_BIN"

          # Function to find and copy a library with the exact name expected
          copy_lib() {
            local expected_name="$1"
            local dest_dir="$2"

            # Skip if already copied
            [ -f "$dest_dir/$expected_name" ] && return 0

            # Search paths
            for searchpath in /opt/homebrew/lib /usr/local/lib; do
              # Try exact name first
              if [ -f "$searchpath/$expected_name" ]; then
                cp -L "$searchpath/$expected_name" "$dest_dir/$expected_name"
                echo "Copied: $searchpath/$expected_name"
                return 0
              fi

              # Try without version number (e.g., libfoo.0.dylib -> libfoo.dylib)
              local base_name=$(echo "$expected_name" | sed 's/\.[0-9]*\.dylib/.dylib/')
              if [ "$base_name" != "$expected_name" ] && [ -f "$searchpath/$base_name" ]; then
                cp -L "$searchpath/$base_name" "$dest_dir/$expected_name"
                echo "Copied: $searchpath/$base_name -> $expected_name"
                return 0
              fi
            done

            echo "Warning: Could not find $expected_name"
            return 1
          }

          # Copy all @rpath dependencies from llama-completion
          echo "=== Copying direct dependencies ==="
          for dep in $(otool -L "$LLAMA_BIN" | grep "@rpath" | awk '{print $1}'); do
            libname=$(basename "$dep")
            copy_lib "$libname" "$RESOURCES_DIR"
          done

          # Recursively copy dependencies of dylibs (up to 3 levels deep)
          for iteration in 1 2 3; do
            echo "=== Copying nested dependencies (iteration $iteration) ==="
            for lib in "$RESOURCES_DIR"/*.dylib; do
              [ -f "$lib" ] || continue
              for dep in $(otool -L "$lib" 2>/dev/null | grep "@rpath" | awk '{print $1}'); do
                libname=$(basename "$dep")
                copy_lib "$libname" "$RESOURCES_DIR"
              done
            done
          done

          # Fix all rpaths - change @rpath to @loader_path
          echo "=== Fixing rpaths ==="
          for file in "$RESOURCES_DIR/llama-completion" "$RESOURCES_DIR"/*.dylib; do
            [ -f "$file" ] || continue
            filename=$(basename "$file")
            echo "Fixing: $filename"

            # Fix the library's own install name (ID) for dylibs
            if [[ "$filename" == *.dylib ]]; then
              install_name_tool -id "@loader_path/$filename" "$file" 2>/dev/null || true
            fi

            # Get all @rpath and Homebrew absolute path references
            otool -L "$file" 2>/dev/null | tail -n +2 | awk '{print $1}' | while read dep; do
              if [[ "$dep" == @rpath/* ]] || [[ "$dep" == /opt/homebrew/* ]] || [[ "$dep" == /usr/local/* ]]; then
                libname=$(basename "$dep")
                install_name_tool -change "$dep" "@loader_path/$libname" "$file" 2>/dev/null || true
              fi
            done
          done

          # Debug: show what we bundled
          echo "=== Bundled files ==="
          ls -la "$RESOURCES_DIR/"
          echo "=== Final llama-completion dependencies ==="
          otool -L "$RESOURCES_DIR/llama-completion"
          echo "=== Sample dylib dependencies ==="
          for lib in "$RESOURCES_DIR"/libllama*.dylib; do
            [ -f "$lib" ] && otool -L "$lib" | head -5
            break
          done

          # Remove quarantine attribute
          xattr -cr "$APP_PATH"

      - name: Create ZIP
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          cd build/Build/Products/Release
          zip -r "AirLingua-${VERSION}.zip" "AirLingua.app"
          mv "AirLingua-${VERSION}.zip" "$GITHUB_WORKSPACE/"
          cd "$GITHUB_WORKSPACE"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          SHA256=$(shasum -a 256 "AirLingua-${VERSION}.zip" | cut -d ' ' -f 1)
          echo "SHA256=${SHA256}" >> $GITHUB_ENV

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: AirLingua-${{ env.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew Tap
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          repository: fuwasegu/homebrew-tap
          event-type: update-airlingua
          client-payload: '{"version": "${{ env.VERSION }}", "sha256": "${{ env.SHA256 }}"}'
